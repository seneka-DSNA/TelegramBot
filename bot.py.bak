from telegram import Update
from telegram.ext import (

ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    CallbackQueryHandler,
    filters
)
from config import BOT_TOKEN
from handlers_auth import start_handler, auth_handler
from handlers_menu import menu_handler
from auth_service import AuthService
from session_manager import SessionManager
from client_repository import ClientRepository
from access_code_repository import AccessCodeRepository
from handlers_client_order import *
from handlers_client_message import client_incoming_message_handler
from handlers_client import client_reply_start_handler, client_reply_message_handler
from handlers_group import group_callback_handler
from handlers_group_message import group_text_message_handler
async def error_handler(update, context):
    print("ERROR:", context.error)
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # Servicios
    session_manager = SessionManager(ttl_seconds=1800)
    auth_service = AuthService(
        ClientRepository(),
        AccessCodeRepository(),
    )

    app.bot_data["session_manager"] = session_manager
    app.bot_data["auth_service"] = auth_service

    app.add_handler(CommandHandler("start", start_handler))
    app.add_handler(MessageHandler(filters.TEXT & filters.ChatType.PRIVATE, auth_handler), group=0)
    app.add_handler(CommandHandler("menu", menu_handler))
    
    #ORDER HANDLERS
    app.add_handler(
        CallbackQueryHandler(client_order_start, pattern="^CLIENT_ORDER$")
)

    app.add_handler(
        CallbackQueryHandler(client_order_product_callback, pattern="^ORDER_(INC|DEC|NEXT)_?|^ORDER_NEXT$")
)

    app.add_handler(
        CallbackQueryHandler(client_order_confirm_callback, pattern="^ORDER_(CONFIRM|CANCEL)$")
)
    app.add_handler(
        CallbackQueryHandler(client_reply_start_handler, pattern=r"^CLIENT_REPLY$")
)
    app.add_handler(
        MessageHandler(filters.ChatType.PRIVATE & filters.TEXT, client_incoming_message_handler)
)
    app.add_handler(
        MessageHandler(filters.ChatType.PRIVATE & filters.TEXT, client_reply_message_handler)
)
       
    app.add_handler(
        CallbackQueryHandler(client_order_time_callback, pattern="^TIME_") 
)

    app.add_handler(
        MessageHandler(filters.TEXT & ~filters.COMMAND, client_order_text_handler),
        group=1
)
    # GROUP HANDLERS
    app.add_handler(
        CallbackQueryHandler(group_callback_handler, pattern=r"^GROUP_MSG_")
)
    app.add_handler( 
        MessageHandler(filters.ChatType.GROUPS & filters.TEXT, group_text_message_handler)
)
    async def error_handler(update, context):
        print("ERROR:", context.error)
    app.add_error_handler(error_handler)
    app.run_polling()
if __name__ == "__main__":
    main()

